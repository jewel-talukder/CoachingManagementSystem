# ğŸš€ Complete IIS Deployment Guide for Next.js

## âœ… Quick Fix Summary

Your Next.js project uses **standalone output**, which requires:
1. Node.js installed on IIS server
2. iisnode installed on IIS server  
3. Deploy the `.next/standalone` folder (not the root folder)
4. `web.config` must be in the standalone folder

---

## ğŸ“‹ Prerequisites (MUST HAVE on IIS Server)

### 1. Install Node.js
- Download from: https://nodejs.org/
- Install **Node.js v18 or higher**
- Verify installation:
  ```powershell
  node --version
  npm --version
  ```

### 2. Install iisnode
- Download from: https://github.com/Azure/iisnode/releases
- Install the **x64** version (for 64-bit Windows)
- Verify installation:
  ```powershell
  Get-ItemProperty HKLM:\SOFTWARE\Microsoft\IISNode
  ```

### 3. Install URL Rewrite Module
- Download from: https://www.iis.net/downloads/microsoft/url-rewrite
- Install on IIS server
- Required for `web.config` rewrite rules

---

## ğŸ”¨ Build and Deploy Steps

### Step 1: Build Your Project

On your development machine:

```powershell
cd D:\Jewel\MySelf\CoachingManagementSystem\coaching-frontend
npm install
npm run build
```

This creates the standalone build in: `.next\standalone\`

### Step 2: Run Deployment Script

```powershell
.\deploy-to-iis.ps1
```

This script will:
- âœ… Build your project
- âœ… Copy `web.config` to `.next\standalone\`
- âœ… Create a `deploy-package` folder ready for deployment

### Step 3: Deploy to IIS Server

**Option A: Copy Files Manually**

1. Copy **ALL contents** from `.next\standalone\` folder to IIS:
   ```
   C:\inetpub\wwwroot\coaching-app\
   ```

2. Make sure these files are in the root:
   - âœ… `server.js` (generated by Next.js)
   - âœ… `web.config` (IIS configuration)
   - âœ… `package.json`
   - âœ… `node_modules\` folder
   - âœ… `.next\` folder

**Option B: Use Deployment Script**

The script creates a `deploy-package` folder. Zip it and extract on IIS server.

### Step 4: Configure IIS Website

1. **Open IIS Manager**

2. **Create New Website:**
   - Right-click "Sites" â†’ "Add Website"
   - **Site name:** `CoachingManagementSystem`
   - **Physical path:** `C:\inetpub\wwwroot\coaching-app`
   - **Port:** `80` (or your preferred port, e.g., `5000`)
   - Click "OK"

3. **Configure Application Pool:**
   - Go to "Application Pools"
   - Find your application pool (usually same name as site)
   - Right-click â†’ "Advanced Settings"
   - Set these values:
     - **.NET CLR Version:** `No Managed Code`
     - **Enable 32-Bit Applications:** `False` (if using 64-bit Node.js)
     - **Idle Timeout:** `0` (to keep Node.js running)
     - **Start Mode:** `AlwaysRunning`

4. **Set Permissions:**
   - Right-click `C:\inetpub\wwwroot\coaching-app` folder
   - Properties â†’ Security tab
   - Add `IIS_IUSRS` with "Read & Execute" permissions
   - Add `IIS AppPool\YourAppPoolName` with "Read & Execute" permissions

### Step 5: Test Your Application

1. **Test iisnode:**
   ```
   http://localhost:5000/server.js
   ```
   Should show Node.js information (not 404)

2. **Test your app:**
   ```
   http://localhost:5000/
   ```
   Should load your Next.js application

---

## ğŸ” Troubleshooting

### Problem: HTTP Error 403.14 - Forbidden

**Solution:**
- âœ… Check `web.config` is in the root of deployed folder
- âœ… Check iisnode is installed
- âœ… Check Node.js is installed
- âœ… Check file permissions (IIS_IUSRS has access)

### Problem: HTTP Error 500 - Internal Server Error

**Solution:**
1. **Check iisnode logs:**
   ```
   C:\inetpub\wwwroot\coaching-app\iisnode\
   ```

2. **Check Windows Event Viewer:**
   - Open Event Viewer
   - Windows Logs â†’ Application
   - Look for errors from iisnode

3. **Check Node.js version:**
   ```powershell
   node --version
   ```
   Must be v18 or higher

4. **Check server.js exists:**
   - Should be in: `C:\inetpub\wwwroot\coaching-app\server.js`
   - This file is generated by Next.js build

### Problem: Page Not Loading / Blank Page

**Solution:**
1. **Check browser console** for JavaScript errors
2. **Check API connection:**
   - Verify `.env.production` has correct API URL
   - Check CORS settings on API server
3. **Check Next.js build:**
   - Verify `.next` folder exists in deployed location
   - Verify `node_modules` folder exists

### Problem: Static Files Not Loading (CSS, Images)

**Solution:**
1. **Check `web.config` rewrite rules** are correct
2. **Check `public` folder** exists in deployed location
3. **Check MIME types** in IIS:
   - IIS Manager â†’ Your Site â†’ MIME Types
   - Ensure `.css`, `.js`, `.json` are configured

---

## ğŸ“ File Structure After Deployment

Your IIS folder should look like this:

```
C:\inetpub\wwwroot\coaching-app\
â”œâ”€â”€ server.js              (Next.js server - REQUIRED)
â”œâ”€â”€ web.config             (IIS config - REQUIRED)
â”œâ”€â”€ package.json           (REQUIRED)
â”œâ”€â”€ .next\                 (Next.js build - REQUIRED)
â”‚   â”œâ”€â”€ server\
â”‚   â”œâ”€â”€ static\
â”‚   â””â”€â”€ ...
â”œâ”€â”€ node_modules\          (Dependencies - REQUIRED)
â”œâ”€â”€ public\                (Static files - REQUIRED)
â”‚   â”œâ”€â”€ next.svg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ .env.production        (Environment variables)
â””â”€â”€ iisnode\              (Logs - created automatically)
```

---

## âœ… Verification Checklist

Before deploying, make sure:

- [ ] Node.js v18+ installed on IIS server
- [ ] iisnode installed on IIS server
- [ ] URL Rewrite Module installed
- [ ] Project built successfully (`npm run build`)
- [ ] `web.config` copied to `.next\standalone\`
- [ ] All files from `standalone` folder copied to IIS
- [ ] IIS website created and pointing to correct folder
- [ ] Application Pool configured correctly
- [ ] File permissions set correctly
- [ ] Test `http://localhost:PORT/server.js` works
- [ ] Test `http://localhost:PORT/` loads your app

---

## ğŸš€ Quick Deploy Command

Run this on your development machine:

```powershell
.\deploy-to-iis.ps1
```

Then copy the `deploy-package` folder to your IIS server!

---

## ğŸ“ Still Having Issues?

1. **Check iisnode logs:** `C:\inetpub\wwwroot\coaching-app\iisnode\`
2. **Check Windows Event Viewer** for detailed errors
3. **Verify all prerequisites** are installed
4. **Test with a simple Node.js file** to verify iisnode works

---

## ğŸ’¡ Important Notes

- **DO NOT** deploy the root project folder - only deploy `.next\standalone\`
- **DO NOT** deploy `node_modules` from root - use the one in `standalone`
- **ALWAYS** copy `web.config` to the standalone folder after build
- The `server.js` in standalone is **different** from root `server.js` - use the one in standalone!

